#!/usr/bin/env bash
#
# FimCode CLI å®‰è£…è„šæœ¬
#
# ä½¿ç”¨æ–¹æ³•:
#   curl -fsSL https://raw.githubusercontent.com/Fim98/fimcode/main/install | bash
#
# ç¯å¢ƒå˜é‡:
#   VERSION    æŒ‡å®šè¦å®‰è£…çš„ç‰ˆæœ¬ (é»˜è®¤: latest)
#   INSTALL_DIR æŒ‡å®šå®‰è£…ç›®å½• (é»˜è®¤: ~/.fimcode/bin)
#

set -e

# é…ç½®
APP_NAME="fimcode"
GITHUB_REPO="Fim98/fimcode"
INSTALL_DIR="${INSTALL_DIR:-$HOME/.fimcode/bin}"
VERSION="${VERSION:-latest}"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰“å°ä¿¡æ¯
info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æµ‹å¹³å°
detect_platform() {
    local os
    local arch

    # æ£€æµ‹æ“ä½œç³»ç»Ÿ
    os=$(uname -s | tr '[:upper:]' '[:lower:]')
    case "$os" in
        linux)
            PLATFORM="linux"
            ;;
        darwin)
            PLATFORM="darwin"
            ;;
        mingw*|msys*|cygwin*)
            PLATFORM="windows"
            ;;
        *)
            error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $os"
            exit 1
            ;;
    esac

    # æ£€æµ‹æ¶æ„
    arch=$(uname -m)
    case "$arch" in
        x86_64|amd64)
            ARCH="x64"
            ;;
        arm64|aarch64)
            ARCH="arm64"
            ;;
        *)
            error "ä¸æ”¯æŒçš„æ¶æ„: $arch"
            exit 1
            ;;
    esac

    info "æ£€æµ‹åˆ°å¹³å°: ${PLATFORM}-${ARCH}"
}

# æ£€æµ‹ musl (Alpine Linux)
detect_musl() {
    IS_MUSL=false

    if [ "$PLATFORM" = "linux" ]; then
        if [ -f /etc/alpine-release ]; then
            IS_MUSL=true
        elif ldd --version 2>&1 | grep -q musl; then
            IS_MUSL=true
        fi
    fi

    if [ "$IS_MUSL" = true ]; then
        info "æ£€æµ‹åˆ° musl ç¯å¢ƒ (Alpine Linux)"
    fi
}

# æ£€æµ‹æ˜¯å¦éœ€è¦ baseline ç‰ˆæœ¬ (æ—§ CPU å…¼å®¹)
detect_baseline() {
    NEEDS_BASELINE=false

    if [ "$PLATFORM" = "linux" ] && [ "$ARCH" = "x64" ]; then
        # æ£€æŸ¥ CPU æ˜¯å¦æ”¯æŒ AVX2
        if [ -f /proc/cpuinfo ]; then
            if ! grep -q "avx2" /proc/cpuinfo 2>/dev/null; then
                NEEDS_BASELINE=true
            fi
        fi
    fi

    if [ "$NEEDS_BASELINE" = true ]; then
        info "æ£€æµ‹åˆ°æ—§ CPUï¼Œä½¿ç”¨å…¼å®¹ç‰ˆæœ¬"
    fi
}

# æ„å»ºæ–‡ä»¶å
build_filename() {
    local target="${APP_NAME}-${PLATFORM}-${ARCH}"

    if [ "$NEEDS_BASELINE" = true ]; then
        target="${target}-baseline"
    fi

    if [ "$IS_MUSL" = true ]; then
        target="${target}-musl"
    fi

    if [ "$PLATFORM" = "linux" ]; then
        FILENAME="${target}.tar.gz"
        EXTRACT_CMD="tar -xzf"
    else
        FILENAME="${target}.zip"
        EXTRACT_CMD="unzip -q"
    fi

    info "ä¸‹è½½æ–‡ä»¶: ${FILENAME}"
}

# è·å–ä¸‹è½½ URL
get_download_url() {
    if [ "$VERSION" = "latest" ]; then
        DOWNLOAD_URL="https://github.com/${GITHUB_REPO}/releases/latest/download/${FILENAME}"
    else
        DOWNLOAD_URL="https://github.com/${GITHUB_REPO}/releases/download/v${VERSION}/${FILENAME}"
    fi

    info "ä¸‹è½½åœ°å€: ${DOWNLOAD_URL}"
}

# ä¸‹è½½æ–‡ä»¶
download() {
    local tmp_dir
    tmp_dir=$(mktemp -d)
    TMP_FILE="${tmp_dir}/${FILENAME}"

    info "å¼€å§‹ä¸‹è½½..."

    if command -v curl >/dev/null 2>&1; then
        curl -fsSL -o "$TMP_FILE" "$DOWNLOAD_URL" --progress-bar
    elif command -v wget >/dev/null 2>&1; then
        wget -q --show-progress -O "$TMP_FILE" "$DOWNLOAD_URL"
    else
        error "éœ€è¦ curl æˆ– wget æ¥ä¸‹è½½æ–‡ä»¶"
        exit 1
    fi

    if [ ! -f "$TMP_FILE" ]; then
        error "ä¸‹è½½å¤±è´¥"
        exit 1
    fi

    success "ä¸‹è½½å®Œæˆ"
}

# å®‰è£…æ–‡ä»¶
install_binary() {
    info "å®‰è£…åˆ° ${INSTALL_DIR}..."

    # åˆ›å»ºå®‰è£…ç›®å½•
    mkdir -p "$INSTALL_DIR"

    # è§£å‹
    local tmp_dir
    tmp_dir=$(dirname "$TMP_FILE")

    info "è§£å‹æ–‡ä»¶..."
    cd "$tmp_dir"
    $EXTRACT_CMD "$TMP_FILE"

    # ç§»åŠ¨äºŒè¿›åˆ¶æ–‡ä»¶
    local binary_name="${APP_NAME}"
    if [ "$PLATFORM" = "windows" ]; then
        binary_name="${binary_name}.exe"
    fi

    # æŸ¥æ‰¾è§£å‹åçš„äºŒè¿›åˆ¶æ–‡ä»¶
    local extracted_binary
    if [ -f "${tmp_dir}/bin/${binary_name}" ]; then
        extracted_binary="${tmp_dir}/bin/${binary_name}"
    elif [ -f "${tmp_dir}/${binary_name}" ]; then
        extracted_binary="${tmp_dir}/${binary_name}"
    else
        error "æ‰¾ä¸åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: ${binary_name}"
        exit 1
    fi

    # ç§»åŠ¨åˆ°å®‰è£…ç›®å½•
    mv "$extracted_binary" "${INSTALL_DIR}/${binary_name}"
    chmod +x "${INSTALL_DIR}/${binary_name}"

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf "$tmp_dir"

    success "å®‰è£…å®Œæˆ"
}

# æ·»åŠ åˆ° PATH
add_to_path() {
    local shell_rc=""
    local current_shell=""

    # æ£€æµ‹å½“å‰ shell
    if [ -n "$SHELL" ]; then
        current_shell=$(basename "$SHELL")
    fi

    # æ£€æµ‹ shell é…ç½®æ–‡ä»¶
    case "$current_shell" in
        bash)
            if [ -f "$HOME/.bashrc" ]; then
                shell_rc="$HOME/.bashrc"
            elif [ -f "$HOME/.bash_profile" ]; then
                shell_rc="$HOME/.bash_profile"
            fi
            ;;
        zsh)
            if [ -f "$HOME/.zshrc" ]; then
                shell_rc="$HOME/.zshrc"
            fi
            ;;
        fish)
            shell_rc="$HOME/.config/fish/config.fish"
            ;;
    esac

    # æ£€æŸ¥ PATH æ˜¯å¦å·²åŒ…å«å®‰è£…ç›®å½•
    if echo "$PATH" | grep -q "$INSTALL_DIR"; then
        info "${INSTALL_DIR} å·²åœ¨ PATH ä¸­"
        return
    fi

    # æ·»åŠ åˆ° PATH
    if [ -n "$shell_rc" ]; then
        info "æ·»åŠ åˆ° ${shell_rc}..."
        echo "" >> "$shell_rc"
        echo "# FimCode CLI" >> "$shell_rc"
        echo "export PATH=\"${INSTALL_DIR}:\$PATH\"" >> "$shell_rc"
        success "å·²æ·»åŠ åˆ° PATH"
        warn "è¯·è¿è¡Œ 'source ${shell_rc}' æˆ–é‡æ–°æ‰“å¼€ç»ˆç«¯ä½¿æ›´æ”¹ç”Ÿæ•ˆ"
    else
        warn "æ— æ³•è‡ªåŠ¨æ·»åŠ åˆ° PATH"
        info "è¯·æ‰‹åŠ¨å°† ${INSTALL_DIR} æ·»åŠ åˆ° PATH"
    fi
}

# éªŒè¯å®‰è£…
verify_install() {
    info "éªŒè¯å®‰è£…..."

    local binary_path="${INSTALL_DIR}/${APP_NAME}"
    if [ "$PLATFORM" = "windows" ]; then
        binary_path="${binary_path}.exe"
    fi

    if [ ! -f "$binary_path" ]; then
        error "å®‰è£…éªŒè¯å¤±è´¥: æ‰¾ä¸åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
        exit 1
    fi

    # æµ‹è¯•è¿è¡Œ
    local version
    version=$($binary_path --version 2>/dev/null || echo "unknown")
    success "å®‰è£…éªŒè¯æˆåŠŸ: ${version}"
}

# ä¸»å‡½æ•°
main() {
    echo "ğŸš€ FimCode CLI å®‰è£…è„šæœ¬"
    echo ""

    detect_platform
    detect_musl
    detect_baseline
    build_filename
    get_download_url
    download
    install_binary
    add_to_path
    verify_install

    echo ""
    success "FimCode å®‰è£…æˆåŠŸï¼"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  fimcode              å¯åŠ¨äº¤äº’æ¨¡å¼"
    echo "  fimcode 'å‘½ä»¤'        æ‰§è¡Œå•æ¡å‘½ä»¤"
    echo "  fimcode upgrade       æ£€æŸ¥å¹¶å‡çº§"
    echo ""
    echo "æ–‡æ¡£: https://github.com/${GITHUB_REPO}"
}

# è¿è¡Œä¸»å‡½æ•°
main
